"use strict";var x=15/18,j="#111",F=15,q="Ver 1.0",C={},G=3;function i(){G--}function b(t,r){for(var i=Array(t),e=0;e<t;e++)i[e]=r(e);return i}C.t=new Image,C.t.src="pictures/game/board.jpg",C.t.onload=i,C.i=new Image,C.i.src="pictures/game/bg.jpg",C.i.onload=i,C.h=new Image,C.h.src="pictures/game/piece.png",C.h.onload=i;var r=(new Date).getTime()%1003;function d(t,i){return(32767&(r=214013*r+2531011))%(i-t)+t}function l(){return 0}function D(){}var e=[100,100,400,400,1e3,1e3,2e3,4e3];function v(o,t,r){function i(t){for(var r=[0,0,0],i=0;i<t;i++)r[o[i]]++;return r}var e,n,s=[];function h(t,r,i){for(;1!=o[t];)t++;for(var e=0;e<s.length;e++)if(s[e][1]==r&&s[e][2]==t)return i>s[e][0]&&(s[e][0]=i),0;s.push([i,r,t])}for(n=0;n<=t-6;n++)0==n?e=i(6):(e[o[n-1]]--,e[o[n+5]]++),0==e[2]&&0!=e[1]&&0==o[n]&&0==o[n+5]&&h(n,e[1],2*e[1]-2);for(n=0;n<=t-5;n++)0==n?e=i(5):(e[o[n-1]]--,e[o[n+4]]++),0!=e[2]||e[1]<2||h(n,e[1],2*e[1]-3);for(n=0;n<s.length;n++)r[s[n][0]]++}function H(m){function a(t,r){for(var i=0;i<8;i++)t[i]=r[i]}function f(t,r){for(var i=0;i<8;i++)t[i]-=r[i],r[i]=0}function c(t,r){for(var i=0;i<8;i++)t[i]+=r[i]}this.reset=function(){this.t=b(m,function(){return b(m,l)}),this.o=0,this.u=b(4,function(t){return b(t<2?m:2*m-1,function(){return b(2,function(){return b(8,l)})})}),this.v=b(2,function(){return b(8,l)})},this.reset(),this.restore=function(t,r){var i;return r&&((i=[[0,Array(8),Array(8)],[0,Array(8),Array(8)],[0,Array(8),Array(8)],[0,Array(8),Array(8)]])[0][0]=t[0][0],i[1][0]=t[1][0],i[2][0]=t[2][0],i[3][0]=t[3][0],i[4]=this.o,a(i[0][1],this.u[0][i[0][0]][0]),a(i[0][2],this.u[0][i[0][0]][1]),a(i[1][1],this.u[1][i[1][0]][0]),a(i[1][2],this.u[1][i[1][0]][1]),a(i[2][1],this.u[2][i[2][0]][0]),a(i[2][2],this.u[2][i[2][0]][1]),a(i[3][1],this.u[3][i[3][0]][0]),a(i[3][2],this.u[3][i[3][0]][1])),this.o=t[4],f(this.v[0],this.u[0][t[0][0]][0]),f(this.v[1],this.u[0][t[0][0]][1]),f(this.v[0],this.u[1][t[1][0]][0]),f(this.v[1],this.u[1][t[1][0]][1]),f(this.v[0],this.u[2][t[2][0]][0]),f(this.v[1],this.u[2][t[2][0]][1]),f(this.v[0],this.u[3][t[3][0]][0]),f(this.v[1],this.u[3][t[3][0]][1]),a(this.u[0][t[0][0]][0],t[0][1]),a(this.u[0][t[0][0]][1],t[0][2]),a(this.u[1][t[1][0]][0],t[1][1]),a(this.u[1][t[1][0]][1],t[1][2]),a(this.u[2][t[2][0]][0],t[2][1]),a(this.u[2][t[2][0]][1],t[2][2]),a(this.u[3][t[3][0]][0],t[3][1]),a(this.u[3][t[3][0]][1],t[3][2]),c(this.v[0],this.u[0][t[0][0]][0]),c(this.v[1],this.u[0][t[0][0]][1]),c(this.v[0],this.u[1][t[1][0]][0]),c(this.v[1],this.u[1][t[1][0]][1]),c(this.v[0],this.u[2][t[2][0]][0]),c(this.v[1],this.u[2][t[2][0]][1]),c(this.v[0],this.u[3][t[3][0]][0]),c(this.v[1],this.u[3][t[3][0]][1]),i},this.update=function(t,r){var i=[[0,Array(8),Array(8)],[0,Array(8),Array(8)],[0,Array(8),Array(8)],[0,Array(8),Array(8)]];i[0][0]=r,i[1][0]=t,i[2][0]=t-r+m-1,i[3][0]=t+r,i[4]=this.o,a(i[0][1],this.u[0][i[0][0]][0]),a(i[0][2],this.u[0][i[0][0]][1]),a(i[1][1],this.u[1][i[1][0]][0]),a(i[1][2],this.u[1][i[1][0]][1]),a(i[2][1],this.u[2][i[2][0]][0]),a(i[2][2],this.u[2][i[2][0]][1]),a(i[3][1],this.u[3][i[3][0]][0]),a(i[3][2],this.u[3][i[3][0]][1]);for(var e,o,n,s=Array(2*m-1),h=Array(2*m-1),u=0;u<m;u++)o=this.t[u][r],s[u]=o,h[u]=2==o?1:1==o?2:0;for(f(this.v[0],this.u[0][r][0]),f(this.v[1],this.u[0][r][1]),v(s,m,this.u[0][r][0]),v(h,m,this.u[0][r][1]),c(this.v[0],this.u[0][r][0]),c(this.v[1],this.u[0][r][1]),u=0;u<m;u++)o=this.t[t][u],s[u]=o,h[u]=2==o?1:1==o?2:0;if(f(this.v[0],this.u[1][t][0]),f(this.v[1],this.u[1][t][1]),v(s,m,this.u[1][t][0]),v(h,m,this.u[1][t][1]),c(this.v[0],this.u[1][t][0]),c(this.v[1],this.u[1][t][1]),i[2][0]<m)for(n=i[2][0]+1,e=m-i[2][u=0]-1;u<n;u++,e++)o=this.t[u][e],s[u]=o,h[u]=2==o?1:1==o?2:0;else for(n=2*m-i[2][0]-1,u=i[2][0]-m+1,e=0;e<n;u++,e++)o=this.t[u][e],s[e]=o,h[e]=2==o?1:1==o?2:0;if(f(this.v[0],this.u[2][i[2][0]][0]),f(this.v[1],this.u[2][i[2][0]][1]),v(s,n,this.u[2][i[2][0]][0]),v(h,n,this.u[2][i[2][0]][1]),c(this.v[0],this.u[2][i[2][0]][0]),c(this.v[1],this.u[2][i[2][0]][1]),i[3][0]<m)for(n=i[3][0]+1,u=i[3][0],e=0;e<n;u--,e++)o=this.t[u][e],s[e]=o,h[e]=2==o?1:1==o?2:0;else for(n=2*m-i[3][0]-1,u=m-1,e=i[3][0]-m+1;e<m;u--,e++)o=this.t[u][e],s[m-u-1]=o,h[m-u-1]=2==o?1:1==o?2:0;return f(this.v[0],this.u[3][i[3][0]][0]),f(this.v[1],this.u[3][i[3][0]][1]),v(s,n,this.u[3][i[3][0]][0]),v(h,n,this.u[3][i[3][0]][1]),c(this.v[0],this.u[3][i[3][0]][0]),c(this.v[1],this.u[3][i[3][0]][1]),i},this.evaluate=function(t){for(var r,i=0,o=this.v,n=t-1,s=1==t?1:0,h=this.o=0;h<8;h++)i+=e[h]*(o[n][h]-o[s][h])-10*(h+1)*o[s][h];for(25e3<i?i=25e3:i<-25e3&&(i=-25e3),0<o[s][7]?(i-=2e5,this.o=s):0<o[n][7]?(i+=2e5,this.o=n):0<o[s][5]||0<o[s][6]?i-=1e5:0<o[n][6]?i+=1e5:1<o[n][5]?i+=9e4:0<o[n][5]&&0<o[n][4]?i+=8e4:0<o[s][4]?i-=7e4:1<o[n][4]&&(i+=6e4),h=0;h<2;h++)for(r=0;r<8;r++)if(0!=o[h][r])return i;return this.o=-1,i},this.points=function(t,r){for(var i,e=[],o=b(m,function(){return b(m,l)}),n=0;n<m;n++)for(g=0;g<m;g++)if(0!=this.t[g][n])for(var s,h,u,a=-2;a<=2;a++)for(s=-2;s<=2;s++)u=a+n,(h=s+g)<0||u<0||m<=h||m<=u||0==this.t[h][u]&&(o[h][u]=1);for(n=0;n<m;n++)for(g=0;g<m;g++)0!=o[g][n]&&(this.t[g][n]=t,i=this.update(g,n),e.push([this.evaluate(t),[g,n]]),i=this.restore(i,!0),e[e.length-1].push(i),this.t[g][n]=0);if(e.sort(function(t,r){return r[0]-t[0]}),e.length<=r)return e;for(var f=e[r-1][0],c=r-1,v=r-1,g=r-2;0<=g&&e[g][0]==f;g--)c=g;for(g=r;g<e.length&&e[g][0]==f;g++)v=g;for(g=0;g<r-c;g++){var y,I=d(c+g,v+1);c+g!=I&&(y=e[c+g],e[c+g]=e[I],e[I]=y)}return e.length=r,e},this.A=function(t,r,i,e,o,n){var s=1&i?1==t?2:1:t;if(i==r)return this.points(s,1)[0][0];for(var h,u,a,f=r-i+1,l=this.points(s,f=f<3?3:f),f=l.length,c=!1,v=0;v<f&&(u=l[v][1],this.t[u[0]][u[1]]=s,h=this.restore(l[v][2],!0),a=0!=this.o?(c=!0,-1==this.o?0:this.evaluate(t)):this.A(t,r,i+1,e,o),this.restore(h),this.t[u[0]][u[1]]=0,1&i?a<o&&(o=a):e<a&&(e=a,0==i&&(n[0]=u[0],n[1]=u[1])),!(o<=e))&&!c;v++);return 1&i?o:e},this.M=function(t,r){if(0==this.o){var i=[0,0];return this.A(t,2*r,0,-1e6,1e6,i),i}}}function loadGame(t){var r=document.getElementById(t),f=r.getContext("2d"),i=r.width,e=r.height,s={},h=[],u=Math.floor(i/e<x?i:e*x),a=Math.floor(u/x);s.l=Math.floor((i-u)/2),s.t=Math.floor((e-a)/2),s.r=s.l+u,s.b=s.t+a;var l=u-2*(t=(t=Math.floor(u/35))<5?5:t),e=Math.floor(1.8*(i=Math.floor((a-u)/6))),o=Math.floor(1.2*i),n=Math.floor(.9*i),c=[];function v(t,r,i){w.t[t][r]=i,w.update(t,r),w.evaluate(i),c.push([t,r,i]),boardItem.F=void 0}function b(t,r,i,e){return{l:t,t:r,r:i+t,b:e+r}}function g(t,r,i){return h.push(i={rect:t,f:{k:r||function(t,r,i){f.fillStyle="#000",f.fillRect(0,0,r,i)},g:i||D}}),i}function y(t,r,s){return(t=g(t,function(t,r,i){f.fillStyle=t.color||j,f.font=o+"px consolas",p(f,{l:0,t:0,r:r,b:i},t.text,n,5)},function(t,r,i,e,o,n){1==r&&s(t)})).text=r,t}function I(t,r,e,o){return o=o||n,(t=g(t,function(t,r,i){f.fillStyle=t.color||j,f.font=o+"px consolas",p(f,{l:0,t:0,r:r,b:i},t.text,o,e)})).text=r,t}function m(t,r,i){return r>=t.l&&r<t.r&&i>=t.t&&i<t.b}function p(t,r,i,e,o){var n,s,h=t.measureText(i).width;switch(Math.floor(--o/3)){case 0:s=r.t+e;break;case 1:s=(r.b+r.t+e)/2;break;case 2:s=r.b;break;default:s=r.t}switch(o%3){case 0:n=r.l;break;case 1:n=(r.r+r.l-h)/2;break;case 2:n=r.r-h;break;default:n=r.l}t.fillText(i,Math.round(n),Math.round(s))}function A(t,r,i){for(var e,o=void 0,n=0;n<h.length;n++)m((e=h[n]).rect,r,i)?(e.p=!0,e.f.g(e,t,r-e.rect.l,i-e.rect.t,e.rect.r-e.rect.l,e.rect.b-e.rect.t),void 0!==o&&(o=e)):e.p&&(e.p=!1,e.f.g(e,2,void 0,void 0,e.rect.r-e.rect.l,e.rect.b-e.rect.t));return o}function M(){var t;if(!(0<G))for(f.drawImage(C.i,s.l,s.t,u,a),t=0;t<h.length;t++){var r=h[t],i=s.l+r.rect.l,e=s.t+r.rect.t;f.translate(i,e);var o=r.rect.r-r.rect.l,n=r.rect.b-r.rect.t;r.f.k(r,o,n),f.translate(-i,-e)}}var w=new H(F);r.addEventListener("click",function(t){var r=Math.round(t.offsetX),t=Math.round(t.offsetY);m(s,r,t)&&A(1,r-s.l,t-s.t)}),r.addEventListener("mousemove",function(t){var r=Math.round(t.offsetX),t=Math.round(t.offsetY);m(s,r,t)&&A(0,r-s.l,t-s.t)}),boardItem=g(b(t,t+3*i,l,l),function(t,r,i){var e,o,n=l/300,s=l/F,h=s/2;function u(t,r,i,e){f.moveTo(t,r),f.lineTo(i,e)}function a(t,r,i){var e;0==t?(e=s/3,f.fillStyle="#0C8",f.fillRect(s*r+h-e/2,s*i+h-e/2,e,e)):1==t?(e=s/4,f.fillStyle="#F80",f.fillRect(s*r+h-e/2,s*i+h-e/2,e,e)):2==t&&(e=s/4,f.fillStyle="#F0F",f.fillRect(s*r+h-e/2,s*i+h-e/2,e,e))}for(n<1&&(n=1),f.drawImage(C.t,0,0,r,i),f.beginPath(),f.lineWidth=n.toString(),f.strokeStyle="#888",e=0;e<F;e++)u(h,s*e+h,l-h,s*e+h),u(s*e+h,h,s*e+h,l-h);for(f.stroke(),e=0;e<F;e++)for(o=0;o<F;o++)!function(t,r,i){var e,o=2*s/3;if(1==t)e=[0,0,64,64];else{if(2!=t)return;e=[64,0,64,64]}f.drawImage(C.h,e[0],e[1],e[2],e[3],s*r+h-o/2,s*i+h-o/2,o,o)}(w.t[e][o],e,o);t.I&&a(0,t.I[0],t.I[1]),t.j&&a(1,t.j[0],t.j[1]),t.F&&a(2,t.F[0],t.F[1])},function(t,r,i,e,o,n){0==r||1==r?(i=Math.floor(i*F/l),e=Math.floor(e*F/l),0==r?t.I&&t.I.x==i&&t.I.y==e||(t.I=[i,e],M()):0==w.o&&0==w.t[i][e]&&R(i,e)):2==r&&t.I&&(t.I=void 0,M())}),I(r=b(t,t,u-2*t,3*i),"五子棋小游戏",5,e).color="#444";var k,S=I(r=b(t,a-t-i,u-2*t,i),"",4);function T(t,r){S.color=r||j,S.text=t}function R(n,s,t,r){function i(t){switch(t){case-1:return"平局(〃'▽'〃)";case 1:return"你赢了(￣▽￣)／";case 2:return"胜负已定(￣.￣)"}return""}v(n,s,1),M();var e="";(t=r?function(){for(var t=[],r=-1;r<=1;r++)for(var i=-1;i<=1;i++){var e=n+r,o=s+i;0<=e&&0<=o&&e<F&&o<F&&0==w.t[e][o]&&t.push([e,o])}if(0!=t.length)return t[d(0,t.length)]}():w.M(2,3))?(e="对方落子 "+t,v(t[0],t[1],2),boardItem.j=t,0!=w.o&&(e=i(w.o))):e=i(w.o),T(e),M()}function E(){w.reset(),boardItem.j=boardItem.F=void 0;var t=Math.floor(F/2);R(t,t,0,!0)}I(r,q,6).color="#444",y(r=b(t,t+l+3*i,e=4*i,2*i),"重来",function(){E()}),y(r={l:r.l+e,t:r.t,r:r.r+e,b:r.b},"悔棋",function(){var t;!function(){if(!(c.length<=2)){for(var t=0;t<2;t++){var r=c.pop();w.t[r[0]][r[1]]=r[2],w.update(r[0],r[1]),w.t[r[0]][r[1]]=0}w.evaluate(1)}}(),0<c.length?(t=c[c.length-1],boardItem.j=t):boardItem.j=void 0,boardItem.F=void 0,M()}),y(r={l:r.l+e,t:r.t,r:r.r+e,b:r.b},"提示",function(){boardItem.F=w.M(1,3),boardItem.F||T("没有可行方案"),M()}),T(""),E(),0<G&&(k=setInterval(function(){G<=0&&(clearInterval(k),M())},100))}