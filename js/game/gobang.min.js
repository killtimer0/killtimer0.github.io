const scale=2,godmode=!1,lineColor='#8888',mptColor='#0C8',moppColor='#F80',mtipColor='#F0F',hr='JS五子棋',rr='2.1',pr='<h3>2.1</h3>修复 AI 在必输局面下乱走的 bug<br>拖动落子逻辑修改<h3>2.0</h3>使用 WebWorker, 速度优化<br>重构代码, 修复了 AI 的一些严重 bug<br>布局优化, 解决 canvas 模糊的问题<br>可自定义先手和难度<br>移动端增加拖动落子',nr=['平局(〃\'▽\'〃)','你赢了(￣▽￣)／','胜负已定(￣.￣)'],gr=[,'简单',,,'一般',,'较难',,'缓慢'];function T(r){return r+'px'}function U(r,n){for(var t=Array(r),a=0;a<r;a++)t[a]=n(a);return t}function X(){return 0}function Y(r,n,t,a){r.beginPath(),r.arc(n,t,a,0,2*Math.PI),r.fill(),r.stroke()}function Z(r,n){return r(),setInterval(r,n)}function _(n,t){return function(r){n(t)}}function yr(r){return document.createElement(r)}function Ar(r,n){r.appendChild(n)}const ar={o:0,t:1,u:2,i:3},or={reset:'重来',v:'退回',k:'提示'};if(!this.document){function p(r,n,t,a){for(var o=U(n,function(){return[0,0]}),e=0,f=4;f<n;f++){for(var c=0,i=!1,u=0,v=0;v<5;v++){switch(r[f-v]){case 1:s=f-v,c++,0==u&&(u=f-v);break;case 2:f+=4-v,i=!0}if(i)break}i||c<2||(5!=c?(b=2*c-2)>o[s][0]&&(o[s]=[b,u]):e++)}for(f=5;f<n;f++){var s,c=0,i=!1,u=0;if(0==r[f-5]&&0==r[f]){for(var b,v=0;v<6;v++){switch(r[f-v]){case 1:s=f-v,c++,0==u&&(u=f-v);break;case 2:f+=5-v,i=!0}if(i)break}i||0==c||2==c&&1<u-s||(b=2*c-1)>o[s][0]&&(o[s]=[b,u])}}for(f=0;f<8;f++)t[f]=0;for(var h=0,f=0;f<n;f++)0!=o[f][0]&&o[f][1]>h&&(t[o[f][0]-1]++,a[o[f][0]-1]++,h=o[f][1]);t[7]+=e,a[7]+=e}function a(r,n){for(var t=U(2,function(){return U(4,function(r){return U(r<2?n:2*n-9,function(){return U(8,X)})})}),a=U(2,function(){return U(8,X)}),o=Array(n),e=0;e<2;e++){var f=[0,2,2];f[e+1]=1;for(var c=0;c<n;c++){for(var i=0;i<n;i++)o[i]=f[r[c][i]];for(p(o,n,t[e][0][c],a[e]),i=0;i<n;i++)o[i]=f[r[i][c]];p(o,n,t[e][1][c],a[e])}for(c=0;c<2*n-9;c++){var u=n-5-c,v=0,s=c+5;for(u<0&&(v=-u,u=0,s=2*n-5-c),i=0;i<s;i++)o[i]=f[r[u+i][v+i]];for(p(o,s,t[e][2][c],a[e]),u=0,s=c+5,n<=(v=4+c)&&(u=v-n+1,v=n-1,s=2*n-5-c),i=0;i<s;i++)o[i]=f[r[u+i][v-i]];p(o,s,t[e][3][c],a[e])}}return[t,a]}function D(r,n,t,a,o,e,f){var c={},i=Array(n);function u(r){for(var n=Array(8),t=0;t<8;t++)n[t]=r[t];return n}function v(r,n){for(var t=0;t<8;t++)r[t]-=n[t]}c.l=[t,a],c.all=[u(f[0]),u(f[1])],r[a][t]=o,c[0]=[u(e[0][0][a]),u(e[1][0][a])],v(f[0],e[0][0][a]),v(f[1],e[1][0][a]);for(var s=0;s<2;s++){(M=[0,2,2])[s+1]=1;for(var b=0;b<n;b++)i[b]=M[r[a][b]];p(i,n,e[s][0][a],f[s])}for(c[1]=[u(e[0][1][t]),u(e[1][1][t])],v(f[0],e[0][1][t]),v(f[1],e[1][1][t]),s=0;s<2;s++){for((M=[0,2,2])[s+1]=1,b=0;b<n;b++)i[b]=M[r[b][t]];p(i,n,e[s][1][t],f[s])}var h=n+t-a-5;if(0<=h&&h<2*n-9){c[2]=[u(e[0][2][h]),u(e[1][2][h])],v(f[0],e[0][2][h]),v(f[1],e[1][2][h]);var k=0,l=h+5;for((d=n-5-h)<0&&(k=-d,d=0,l=2*n-5-h),s=0;s<2;s++){for((M=[0,2,2])[s+1]=1,b=0;b<l;b++)i[b]=M[r[d+b][k+b]];p(i,l,e[s][2][h],f[s])}}if(0<=(h=t+a-4)&&h<2*n-9){c[3]=[u(e[0][3][h]),u(e[1][3][h])],v(f[0],e[0][3][h]),v(f[1],e[1][3][h]);var d=0,l=h+5;n<=(k=4+h)&&(d=k-n+1,k=n-1,l=2*n-5-h);for(var M,s=0;s<2;s++){for((M=[0,2,2])[s+1]=1,b=0;b<l;b++)i[b]=M[r[d+b][k-b]];p(i,l,e[s][3][h],f[s])}}return c}this.addEventListener('message',function(r){var[n,a,o,r]=r.data;(o=t(n,a,r,o))?this.postMessage([!0,o]):this.postMessage([!1])});const h={D:0,M:1,g:2},k=[10,10,60,70,150,180,1e3,1200];function M(r,n){for(var t=n-1,n=2-n,a=U(2,X),o=0;o<2;o++)for(var e=0;e<5;e++)a[o]+=r[o][e]*k[e];return 0==(n=a[t]-a[n])?h.D:0<n?h.M:h.g}function g(r,n,t){var a=n-1,o=2-n,e=0;0<r[o][7]?e=-4e5:0<r[a][7]?e=4e5:0<r[o][6]||0<r[o][5]?e=-3e5:0<r[a][6]||1<r[a][5]?e=3e5:0<r[a][5]&&0<r[a][4]?e=2e5:0<r[o][4]?e=-1e5:1<r[a][4]&&(e=1e5);var n=0,f=0,c=0,i=U(2,X);switch(t){case h.D:f=c=5;break;case h.M:f=6,c=4;break;case h.g:f=4,c=6}for(var u=0;u<2;u++)for(var v=0;v<8;v++)i[u]+=r[u][v]*k[u==a&&3<v?3:v];return e+((n=1e5<=(n=i[a]*f-i[o]*c)?99999:n)<=-1e5?-99999:n)}function A(r,n,t,a,o){for(var e=0;e<2;e++)for(var f=0;f<8;f++)a[e][f]=o.all[e][f];var[c,i]=o.l;t[0][0][i]=o[0][0],t[1][0][i]=o[0][1],t[0][1][c]=o[1][0],t[1][1][c]=o[1][1];var u=n+c-i-5;0<=u&&u<2*n-9&&(t[0][2][u]=o[2][0],t[1][2][u]=o[2][1]),0<=(u=c+i-4)&&u<2*n-9&&(t[0][3][u]=o[3][0],t[1][3][u]=o[3][1]),r[i][c]=0}function I(r,n,t,a,o,e){for(var f,c=[],i=U(n,function(){return U(n,X)}),u=M(e,o),v=0;v<n;v++)for(var s=0;s<n;s++)if(0!=r[v][s]){var b=v-2,h=s-2,k=v+3,l=s+3;h<0&&(h=0),n<k&&(k=n),n<l&&(l=n);for(var p=b=b<0?0:b;p<k;p++)for(var d=h;d<l;d++)i[p][d]=1}for(v=0;v<n;v++)for(s=0;s<n;s++)0==r[v][s]&&0!=i[v][s]&&(f=D(r,n,s,v,t,o,e),mark=g(e,t,u),A(r,n,o,e,f),c.push([mark,[v,s]]));return c.sort(function(r,n){return n[0]-r[0]}),c.length<=a||(c.length=a),c}function t(l,p,d,m){const w=[16,10,10,8,8,6,6];var[y,r]=function(){for(var r,n=0,t=0;t<l;t++)for(var a=0;a<l;a++)0!=p[t][a]&&(n++,r=[a,t]);var o=Math.floor(l/2);if(0==n)return[[o,o]];if(1!=n)return[!1,n];if(r[0]==o&&r[1]==o)return 4<=(f=7<(f=Math.floor(8*Math.random()))?7:f)&&f++,f=(f-(e=f%3))/3,[[o+--e,o+--f]];var o=l/2,e=r[0]<o?1:r[0]>o?-1:0,f=r[1]<o?1:r[1]>o?-1:0;return[[r[1]+f,r[0]+e]]}();if(y)return y;if(0==(d=(r=l*l-r)<d?r:d))return!1;var[$,C]=a(p,l);return function r(n,t,a,o){if(t==d)return g(C,m,M(C,m));for(var e=t<7?w[t]:4,f=I(p,l,n,e,$,C),e=f.length,c=3-n,i=t+1,u=t%2==0,v=0;v<e;v++){var s=f[v][1][1],b=f[v][1][0],h=D(p,l,s,b,n,$,C),k=0<C[n-1][7]?g(C,m,M(C,m))+4e5*(n==m?d-t:t-d):r(c,i,a,o);if(u?a<k&&(a=k,0==t&&(y=[b,s])):k<o&&(o=k,0==t&&(y=[b,s])),A(p,l,$,C,h),o<=a)break}return u?a:o}(m,0,-(r=1e6+4e5*d),r),y}}function loadGobangGame(r,u,e,i,n,t){var a=document.getElementById(r);if(!a)return console.warn(`No object names '${r}'`),!1;var f,o,c=0,v=e*scale,s=e/30,b=yr('canvas');b.width=b.height=v,b.style.width=b.style.height=T(e),b.style.margin=T(s);var h=b.getContext('2d');(p=yr('table')).style.width=T(i),p.style.height=T(e),p.style.padding=T(s),p.style.paddingBottom='0';var k=yr('span');k.innerText='123';var l=yr('table');l.style.margin='auto',l.style.userSelect='none',l.style.position='relative',function(){function r(r,n){r.style.position='absolute',r.style.left=r.style.top=0,r.style.width=r.style.height='100%',r.style.padding=r.style.margin=0,r.style.zIndex=n}r(I=yr('div'),1e4),I.style.background='white',I.style.opacity=.7,I.hidden=!0,r(g=yr('div'),12e3),g.style.userSelect='text',g.hidden=!0;var t=yr('div');t.style.padding=T(s),g.style.overflowY='auto',Ar(g,t),Ar(l,g),function(){function r(r,n){(n=yr(n||'p')).innerHTML=r,Ar(t,n)}r(hr,'h2'),r('版本: '+rr+'<br>作者: KillTimer'),r('更新内容','h2'),r(pr);var n=yr('button');n.innerText='确定',n.style.paddingLeft=n.style.paddingRight=T(s),n.addEventListener('click',function(){I.hidden=g.hidden=!0}),Ar(t,n)}(),Ar(l,I)}();var p=yr('td'),d=yr('tr'),M=yr('td');Ar(M,b),Ar(d,M),(M=yr('td')).style.width=T(i),M.style.height=T(e);var m,w,I,g,y=yr('table');function A(){o&&o.terminate(),(o=new Worker(n)).addEventListener('message',D)}function D(r){var n,r=r.data;N&&f==ar.t?(n=r[1],clearInterval(W),r[0]?(fr(n[1],n[0]),B=n,$()):er('没有可行方案'),N=!1):!N&&f==ar.u&&r[0]&&(n=r[1],G((j=n)[1],n[0]))}function $(){h.resetTransform(),h.clearRect(0,0,v,v);var r=v/u,n=r/2,t=r/40;h.beginPath(),h.lineWidth=t.toString(),h.strokeStyle=lineColor;for(var a=0;a<u;a++)h.moveTo(n,r*(a+.5)),h.lineTo(v-n,r*(a+.5)),h.moveTo(r*(a+.5),n),h.lineTo(r*(a+.5),v-n);h.stroke();var o=.4*r,e=h.createRadialGradient(.4*o,.4*-o,0,o/4,-o/4,.7*o);e.addColorStop(0,'#CCC'),e.addColorStop(1,'black');var f=h.createRadialGradient(.4*o,.4*-o,0,o/4,-o/4,.7*o);f.addColorStop(0,'white'),f.addColorStop(1,'#DDD');for(var c,a=0;a<u;a++)for(var i=0;i<u;i++)1==x[i][a]&&J||2==x[i][a]&&!J?(h.strokeStyle='black',h.fillStyle=e,h.resetTransform(),h.translate(r*(a+.5),r*(i+.5)),Y(h,0,0,o)):0!=x[i][a]&&(h.strokeStyle='#DDD',h.fillStyle=f,h.resetTransform(),h.translate(r*(a+.5),r*(i+.5)),Y(h,0,0,o));j&&(a=j[1],i=j[0],c=.16*r,h.fillStyle=moppColor,h.resetTransform(),h.translate(r*(a+.5),r*(i+.5)),h.fillRect(-c,-c,2*c,2*c)),B&&(a=B[1],i=B[0],c=.13*r,h.fillStyle=mtipColor,h.resetTransform(),h.translate(r*(a+.5),r*(i+.5)),h.fillRect(-c,-c,2*c,2*c)),P&&(a=P[1],i=P[0],c=.1*r,h.fillStyle=mptColor,h.resetTransform(),h.translate(r*(a+.5),r*(i+.5)),h.fillRect(-c,-c,2*c,2*c))}y.style.width=T(i),y.style.height=T(e),y.style.padding=T(s),y.style.paddingBottom='0',Ar(r=yr('tr'),p),Ar(y,r),(r=yr('tfoot')).style.textAlign='center',r.style.cursor='pointer',m=r,(w=yr('span')).style.color='darkslategrey',w.style.fontSize=T(.7*s),w.innerText=`${hr} Ver ${rr}`,Ar(m,w),r.addEventListener('click',function(r){g.hidden=I.hidden=!1}),Ar(y,r),Ar(M,y),Ar(d,M),Ar(l,d),d=yr('tr'),(M=yr('td')).rowSpan='2',Ar(M,k),Ar(d,M),Ar(l,d),Ar(a,l);var C=!0,F=1;!function(){var n=i/2;function r(r){r.style.width=T(n),r.style.display='block',r.style.marginLeft=r.style.marginRight='auto',r.style.marginBottom=T(s),r.style.paddingTop=r.style.paddingBottom=T(3),r.style.textAlign='center'}var t,a=yr('select');a.style.appearance=a.style.background='none',(t=yr('option')).value=0,t.innerText='我先手',Ar(a,t),(t=yr('option')).value=1,t.innerText='我后手',Ar(a,t),a[f=C?0:1].selected=!0,r(a),a.addEventListener('change',function(r){C=0==a.value}),Ar(p,a);var o=yr('select');o.style.appearance=o.style.background='none';for(var e,f=0;f<gr.length;f++)gr[f]&&((t=yr('option')).value=f,t.innerText=gr[f],f==F&&(t.selected=!0),Ar(o,t));r(o),o.addEventListener('change',function(r){var n=parseInt(o.value);0<n&&(F=n)}),Ar(p,o);for(const c in or)r(e=yr('button')),e.innerText=or[c],e.addEventListener('click',_(wr,or[c])),Ar(p,e)}();var W,x,P,j,B,E,J,N,O=0;function V(){for(var r='计算机思考中',n=0;n<=O;n++)r+='.';er(r),3<=++O&&(O=0)}function q(){for(var r='计算中',n=0;n<=O;n++)r+='.';er(r),3<=++O&&(O=0)}function z(){if(f!=ar.o){for(var r=0,n=0;n<u;n++){for(var t=4;t<u;t++){for(var a=1;a<=2&&!(r=e(a,x[n][t],x[n][t-1],x[n][t-2],x[n][t-3],x[n][t-4])?a:r)&&!(r=e(a,x[t][n],x[t-1][n],x[t-2][n],x[t-3][n],x[t-4][n])?a:r);a++);if(r)break}if(r)break}for(n=4;n<u;n++){for(t=4;t<u;t++){for(a=1;a<=2&&!(r=e(a,x[n][t],x[n-1][t-1],x[n-2][t-2],x[n-3][t-3],x[n-4][t-4])?a:r)&&!(r=e(a,x[n-4][t],x[n-3][t-1],x[n-2][t-2],x[n-1][t-3],x[n][t-4])?a:r);a++);if(r)break}if(r)break}if(r)return f=ar.i,c=r,1;for(var o=0,n=0;n<u;n++)for(t=0;t<u;t++)0!=x[t][n]&&o++;return o==u*u&&(f=ar.i,c=0,1)}function e(r,n,t,a,o,e){return n==r&&t==r&&a==r&&o==r&&e==r&&r}}function G(r,n){switch(f){case ar.o:f=J?ar.t:ar.u;var t=Math.floor(u/2);J||(j=[t,t]),G(t,t);break;case ar.t:H(r,n,1),f=ar.u,z()?G():(N&&(A(),clearInterval(W),N=W=!1),o.postMessage([u,x,2,F]),W=Z(V,1e3)),$();break;case ar.u:H(r,n,2),f=ar.t,W&&(clearInterval(W),W=!1,O=0),fr(r,n),z()&&G(),$();break;case ar.i:er(nr[c])}}function H(r,n,t){x[n][r]=t,E.push([n,r])}function tr(){A(),N=!1,W&&(clearInterval(W),W=!1),f=ar.o,J=C,x=U(u,function(){return U(u,X)}),P=j=B=!1,E=[],G()}function er(r){k.innerText=r}function fr(r,n){er(`[${n}, ${r}]`)}function cr(r,n){return[r=(r=Math.floor(r/e*u))<0?0:u<=r?u-1:r,n=(n=Math.floor(n/e*u))<0?0:u<=n?u-1:n]}function ir(r,n){P&&r==P[1]&&n==P[0]||(f!=ar.t||N||fr(r,n),P=[n,r],$())}function ur(r,n){f==ar.t?0==x[n][r]||godmode?(B=!1,G(r,n)):er('该点已经有子'):f==ar.u&&er('计算机正在思考')}'function'==typeof t&&t(l,b,p,k),tr(),b.addEventListener('mousemove',function(r){var[n,t]=cr(r.offsetX,r.offsetY);ir(n,t),r.preventDefault()}),b.addEventListener('click',function(r){var[n,r]=cr(r.offsetX,r.offsetY);ur(n,r)});var vr,sr,br,kr,lr,dr=0,Mr=e*e/(u*u);function mr(r){var n=b.getBoundingClientRect();return[Math.round(r.clientX-n.x),Math.round(r.clientY-n.y)]}function wr(r){switch(r){case or.v:!function(){var r=0;switch(B=!1,f){case ar.t:r=2;break;case ar.u:A(),W&&(clearInterval(W),W=!1),f=ar.t,r=1;break;case ar.i:r=((J?1:0)+E.length)%2+1,f=ar.t}if(0!=r)if(E.length>=r){for(;r--;){var n=E.pop();x[n[0]][n[1]]=0}0<E.length?(n=E[E.length-1],j=[n[0],n[1]],fr(n[1],n[0]),$()):(f=ar.o,j=!1,G())}else er('已经是开局了')}();break;case or.reset:tr();break;case or.k:f!=ar.t||N||(o.postMessage([u,x,1,F]),W=Z(q,1e3),N=!0)}}b.addEventListener('touchstart',function(r){var n;1==r.touches.length&&([vr,sr]=mr(r.touches[0]),dr=0,[n,r]=cr(vr,sr),ir(n,r),lr=!0)}),b.addEventListener('touchmove',function(r){var n,t,a,o;1==r.touches.length&&lr?([n,t]=mr(r.touches[0]),0==dr?3*Mr<=(a=n-vr)*a+(o=t-sr)*o&&(dr=1,br=Math.round(3*Math.sqrt(20*Mr)/5),kr=Math.round(4*Math.sqrt(20*Mr)/5)):(a=n-br,o=t-kr,n<0||t<0||e<=a||e<=o?(P=!1,$()):([a,o]=cr(a,o),ir(a,o))),r.preventDefault()):lr=!1}),b.addEventListener('touchend',function(r){P&&ur(P[1],P[0]),r.preventDefault()})}