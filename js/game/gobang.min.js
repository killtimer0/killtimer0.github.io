const scale=2,godmode=!1,lineColor='#000C',mptColor='#0C8',moppColor='#F80',mtipColor='#F0F',hr='JS五子棋',rr='2.2',pr='<h3>2.2</h3>又双叒叕修复了 AI 的一个严重 bug<br>增加棋序数字等信息<br>支持键盘移动指针位置(先要点击棋盘获取焦点)<h3>2.1</h3>修复 AI 在必输局面下乱走的 bug<br>拖动落子逻辑修改<h3>2.0</h3>使用 WebWorker, 速度优化<br>重构代码, 修复了 AI 的一些严重 bug<br>布局优化, 解决 canvas 模糊的问题<br>可自定义先手和难度<br>移动端增加拖动落子',nr=['平局(〃\'▽\'〃)','你赢了(￣▽￣)／','胜负已定(￣.￣)'],gr=[,'简单',,,'一般',,'较难',,'大爷'];function T(r){return r+'px'}function U(r,n){for(var a=Array(r),t=0;t<r;t++)a[t]=n(t);return a}function X(){return 0}function Y(r,n,a,t){r.beginPath(),r.arc(n,a,t,0,2*Math.PI),r.fill(),r.stroke()}function Z(r,n){return r(),setInterval(r,n)}function _(n,a){return function(r){n(a)}}function yr(r){return document.createElement(r)}function Ar(r,n){r.appendChild(n)}const ar={o:0,t:1,u:2,i:3},or={reset:'重来',v:'退回',k:'提示',W:'棋序',info:'信息'};if(!this.document){function p(r,n,a,t){for(var e=U(n,function(){return[0,0]}),o=0,f=4;f<n;f++){for(var c=0,i=!1,u=0,v=0;v<5;v++){switch(r[f-v]){case 1:s=f-v,c++,0==u&&(u=f-v);break;case 2:f+=4-v,i=!0}if(i)break}i||c<2||(5!=c?(b=2*c-2)>e[s][0]&&(e[s]=[b,u]):o++)}for(f=5;f<n;f++){var s,c=0,i=!1,u=0;if(0==r[f-5]&&0==r[f]){for(var b,v=0;v<6;v++){switch(r[f-v]){case 1:s=f-v,c++,0==u&&(u=f-v);break;case 2:f+=5-v,i=!0}if(i)break}i||0==c||2==c&&1<u-s||(b=2*c-1)>e[s][0]&&(e[s]=[b,u])}}for(f=0;f<8;f++)a[f]=0;for(var h=0,f=0;f<n;f++)0!=e[f][0]&&e[f][1]>h&&(a[e[f][0]-1]++,t[e[f][0]-1]++,h=e[f][1]);a[7]+=o,t[7]+=o}function a(r,n){for(var a=U(2,function(){return U(4,function(r){return U(r<2?n:2*n-9,function(){return U(8,X)})})}),t=U(2,function(){return U(8,X)}),e=Array(n),o=0;o<2;o++){var f=[0,2,2];f[o+1]=1;for(var c=0;c<n;c++){for(var i=0;i<n;i++)e[i]=f[r[c][i]];for(p(e,n,a[o][0][c],t[o]),i=0;i<n;i++)e[i]=f[r[i][c]];p(e,n,a[o][1][c],t[o])}for(c=0;c<2*n-9;c++){var u=n-5-c,v=0,s=c+5;for(u<0&&(v=-u,u=0,s=2*n-5-c),i=0;i<s;i++)e[i]=f[r[u+i][v+i]];for(p(e,s,a[o][2][c],t[o]),u=0,s=c+5,n<=(v=4+c)&&(u=v-n+1,v=n-1,s=2*n-5-c),i=0;i<s;i++)e[i]=f[r[u+i][v-i]];p(e,s,a[o][3][c],t[o])}}return[a,t]}function D(r,n,a,t,e,o,f){var c={},i=Array(n);function u(r){for(var n=Array(8),a=0;a<8;a++)n[a]=r[a];return n}function v(r,n){for(var a=0;a<8;a++)r[a]-=n[a]}c.l=[a,t],c.all=[u(f[0]),u(f[1])],r[t][a]=e,c[0]=[u(o[0][0][t]),u(o[1][0][t])],v(f[0],o[0][0][t]),v(f[1],o[1][0][t]);for(var s=0;s<2;s++){(w=[0,2,2])[s+1]=1;for(var b=0;b<n;b++)i[b]=w[r[t][b]];p(i,n,o[s][0][t],f[s])}for(c[1]=[u(o[0][1][a]),u(o[1][1][a])],v(f[0],o[0][1][a]),v(f[1],o[1][1][a]),s=0;s<2;s++){for((w=[0,2,2])[s+1]=1,b=0;b<n;b++)i[b]=w[r[b][a]];p(i,n,o[s][1][a],f[s])}var h=n+a-t-5;if(0<=h&&h<2*n-9){c[2]=[u(o[0][2][h]),u(o[1][2][h])],v(f[0],o[0][2][h]),v(f[1],o[1][2][h]);var k=0,l=h+5;for((d=n-5-h)<0&&(k=-d,d=0,l=2*n-5-h),s=0;s<2;s++){for((w=[0,2,2])[s+1]=1,b=0;b<l;b++)i[b]=w[r[d+b][k+b]];p(i,l,o[s][2][h],f[s])}}if(0<=(h=a+t-4)&&h<2*n-9){c[3]=[u(o[0][3][h]),u(o[1][3][h])],v(f[0],o[0][3][h]),v(f[1],o[1][3][h]);var d=0,l=h+5;n<=(k=4+h)&&(d=k-n+1,k=n-1,l=2*n-5-h);for(var w,s=0;s<2;s++){for((w=[0,2,2])[s+1]=1,b=0;b<l;b++)i[b]=w[r[d+b][k-b]];p(i,l,o[s][3][h],f[s])}}return c}this.addEventListener('message',function(r){var[n,a,e,r]=r.data;(e=t(n,a,r,e))?this.postMessage([!0,e]):this.postMessage([!1])});const h={D:0,M:1,g:2},k=[10,10,60,70,150,180,1e3,1200];function M(r,n){for(var a=n-1,n=2-n,t=[0,0],e=0;e<2;e++)for(var o=0;o<5;o++)t[e]+=r[e][o]*k[o];return 0==(n=t[a]-t[n])?h.D:0<n?h.M:h.g}function g(r,n,a){var t=n-1,e=2-n,o=0;0<r[e][7]?o=-5e5:0<r[t][7]?o=5e5:0<r[e][6]?o=-4e5:0<r[e][5]?o=-3e5:0<r[t][6]||1<r[t][5]?o=3e5:0<r[t][5]&&0<r[t][4]?o=2e5:0<r[e][4]?o=-1e5:1<r[t][4]&&(o=1e5);var n=0,f=0,c=0,i=[0,0];switch(a){case h.D:f=c=5;break;case h.M:f=6,c=4;break;case h.g:f=4,c=6}for(var u=0;u<2;u++)for(var v=0;v<8;v++)i[u]+=r[u][v]*k[v];return o+((n=1e5<=(n=i[t]*f-i[e]*c)?99999:n)<=-1e5?-99999:n)}function A(r,n,a,t,e){for(var o=0;o<2;o++)for(var f=0;f<8;f++)t[o][f]=e.all[o][f];var[c,i]=e.l;a[0][0][i]=e[0][0],a[1][0][i]=e[0][1],a[0][1][c]=e[1][0],a[1][1][c]=e[1][1];var u=n+c-i-5;0<=u&&u<2*n-9&&(a[0][2][u]=e[2][0],a[1][2][u]=e[2][1]),0<=(u=c+i-4)&&u<2*n-9&&(a[0][3][u]=e[3][0],a[1][3][u]=e[3][1]),r[i][c]=0}function I(r,n,a,t,e,o){for(var f,c=[],i=U(n,function(){return U(n,X)}),u=M(o,e),v=0;v<n;v++)for(var s=0;s<n;s++)if(0!=r[v][s]){var b=v-2,h=s-2,k=v+3,l=s+3;h<0&&(h=0),n<k&&(k=n),n<l&&(l=n);for(var d=b=b<0?0:b;d<k;d++)for(var p=h;p<l;p++)i[d][p]=1}for(v=0;v<n;v++)for(s=0;s<n;s++)0==r[v][s]&&0!=i[v][s]&&(f=D(r,n,s,v,a,e,o),mark=g(o,a,u),A(r,n,e,o,f),c.push([mark,[v,s]]));return c.sort(function(r,n){return n[0]-r[0]}),c.length<=t||(c.length=t),c}function t(d,p,w,r){const $=[12,10,9,8,7,6,5,5];var[m,n]=function(){for(var r,n=0,a=0;a<d;a++)for(var t=0;t<d;t++)0!=p[a][t]&&(n++,r=[t,a]);var e=Math.floor(d/2);if(0==n)return[[e,e]];if(1!=n)return[!1,n];if(r[0]==e&&r[1]==e)return 4<=(f=7<(f=Math.floor(8*Math.random()))?7:f)&&f++,f=(f-(o=f%3))/3,[[e+--o,e+--f]];var e=d/2,o=r[0]<e?1:r[0]>e?-1:0,f=r[1]<e?1:r[1]>e?-1:0;return[[r[1]+f,r[0]+o]]}();if(m)return m;if(0==(w=(n=d*d-n)<w?n:w))return!1;var[M,y]=a(p,d);return function r(n,a,t,e){if(a==w)return g(y,3-n,h.D);for(var o=a<8?$[a]:4,f=I(p,d,n,o,M,y),o=f.length,c=3-n,i=a+1,u=(w-a)%2==0,v=0;v<o;v++){var s=f[v][1][1],b=f[v][1][0],k=D(p,d,s,b,n,M,y),l=0<y[n-1][7]?g(y,u?c:n,h.D)+5e5*(u?i-w:w-i):r(c,i,t,e);if(u?l<e&&(e=l,0==a&&(m=[b,s])):t<l&&(t=l,0==a&&(m=[b,s])),A(p,d,M,y,k),e<=t)break}return u?e:t}(r,0,-(n=1e6+5e5*w),n),m}}function loadGobangGame(r,v,i,u,n,a){var t=document.getElementById(r);if(!t)return console.warn(`No object names '${r}'`),!1;var f,e,c=0,s=i*scale,b=i/30,o=yr('canvas');o.width=o.height=s,o.style.width=o.style.height=T(i),o.style.margin=T(b);var h=o.getContext('2d');(w=yr('table')).style.width=T(u),w.style.height=T(i),w.style.padding=T(b),w.style.paddingBottom='0';var k=yr('span');k.innerText='123';var l=yr('table');function d(r,n){r.style.position='absolute',r.style.left=r.style.top=0,r.style.width=r.style.height='100%',r.style.padding=r.style.margin=0,r.style.zIndex=n}l.tabIndex=0,l.style.margin='auto',l.style.userSelect='none',l.style.position='relative',d(I=yr('div'),1e4),I.style.background='white',I.style.opacity=.7,I.hidden=!0,d(D=yr('div'),12e3),D.style.userSelect='text',D.hidden=!0,D.style.overflowY='auto',Ar(l,D),Ar(l,I);var p=!1,w=yr('td');function $(r,n,a){(a=yr(a||'p')).innerHTML=n,Ar(r,a)}var m=yr('tr'),M=yr('td');Ar(M,o),Ar(m,M),(M=yr('td')).style.width=T(u),M.style.height=T(i);var A,g,I,D,p,y=yr('table');function C(){e&&e.terminate(),(e=new Worker(n)).addEventListener('message',x)}function x(r){var n,r=r.data;fr&&f==ar.t?(n=r[1],clearInterval(j),r[0]?(br(n[1],n[0]),H=n,W()):sr('没有可行方案'),fr=!1):!fr&&f==ar.u&&r[0]&&(n=r[1],V((G=n)[1],n[0]))}function F(r){p||(r(D,function(){D.innerHTML='',I.hidden=D.hidden=!0,p=!1}),I.hidden=D.hidden=!1,p=!0)}function W(){h.resetTransform(),h.clearRect(0,0,s,s);var r=s/v,n=r/2,a=r/40;h.beginPath(),h.lineWidth=a.toString(),h.strokeStyle=lineColor;for(var t=0;t<v;t++)h.moveTo(n,r*(t+.5)),h.lineTo(s-n,r*(t+.5)),h.moveTo(r*(t+.5),n),h.lineTo(r*(t+.5),s-n);h.stroke();var e=.4*r,o=h.createRadialGradient(.4*e,.4*-e,0,e/4,-e/4,.7*e);o.addColorStop(0,'#CCC'),o.addColorStop(1,'black');var f=h.createRadialGradient(.4*e,.4*-e,0,e/4,-e/4,.7*e);f.addColorStop(0,'white'),f.addColorStop(1,'#DDD');for(var c,i=0;i<tr.length;i++){var t=tr[i][1],u=tr[i][0];h.resetTransform(),h.translate(r*(t+.5),r*(u+.5)),i%2==0?(h.strokeStyle='black',h.fillStyle=o):(h.strokeStyle='#DDD',h.fillStyle=f),Y(h,0,0,e)}if(G&&(t=G[1],u=G[0],c=.16*r,h.fillStyle=moppColor,h.resetTransform(),h.translate(r*(t+.5),r*(u+.5)),h.fillRect(-c,-c,2*c,2*c)),H&&(t=H[1],u=H[0],c=.13*r,h.fillStyle=mtipColor,h.resetTransform(),h.translate(r*(t+.5),r*(u+.5)),h.fillRect(-c,-c,2*c,2*c)),z&&(t=z[1],u=z[0],c=.1*r,h.fillStyle=mptColor,h.resetTransform(),h.translate(r*(t+.5),r*(u+.5)),h.fillRect(-c,-c,2*c,2*c)),h.font=`${Math.round(2*r/5)}px Arial`,h.textAlign='center',h.textBaseline='middle',cr)for(i=0;i<tr.length;i++)t=tr[i][1],u=tr[i][0],h.resetTransform(),h.translate(r*(t+.5),r*(u+.5)),h.fillStyle=i%2==0?'white':'black',h.fillText(i+1,0,0)}y.style.width=T(u),y.style.height=T(i),y.style.padding=T(b),y.style.paddingBottom='0',Ar(r=yr('tr'),w),Ar(y,r),(r=yr('tfoot')).style.textAlign='center',r.style.cursor='pointer',A=r,(g=yr('span')).style.color=lineColor,g.style.fontSize=T(.7*b),g.innerText=`${hr} Ver ${rr}`,Ar(A,g),r.addEventListener('click',function(r){F(function(r,n){var a=yr('div');a.style.padding=T(b),$(a,hr,'h2'),$(a,'版本: '+rr+'<br>作者: KillTimer'),$(a,'更新内容','h2'),$(a,pr);var t=yr('button');t.innerText='确定',t.style.paddingLeft=t.style.paddingRight=T(b),t.addEventListener('click',n),Ar(a,t),Ar(r,a)})}),Ar(y,r),Ar(M,y),Ar(m,M),Ar(l,m),m=yr('tr'),(M=yr('td')).rowSpan='2',Ar(M,k),Ar(m,M),Ar(l,m),Ar(t,l);var E=!0,P=1;!function(){var n=u/2;function r(r){r.style.width=T(n),r.style.display='block',r.style.marginLeft=r.style.marginRight='auto',r.style.marginBottom=T(b),r.style.paddingTop=r.style.paddingBottom=T(3),r.style.textAlign='center'}var a,t=yr('select');t.style.appearance='none',(a=yr('option')).value=0,a.innerText='我先手',Ar(t,a),(a=yr('option')).value=1,a.innerText='我后手',Ar(t,a),t[f=E?0:1].selected=!0,r(t),t.addEventListener('change',function(r){E=0==t.value}),Ar(w,t);var e=yr('select');e.style.appearance='none';for(var o,f=0;f<gr.length;f++)gr[f]&&((a=yr('option')).value=f,a.innerText=gr[f],f==P&&(a.selected=!0),Ar(e,a));r(e),e.addEventListener('change',function(r){var n=parseInt(e.value);0<n&&(P=n)}),Ar(w,e);for(const c in or)r(o=yr('button')),o.innerText=or[c],o.addEventListener('click',_(Wr,or[c])),Ar(w,o)}();var j,B=0;function J(){for(var r='计算机思考中',n=0;n<=B;n++)r+='.';sr(r),3<=++B&&(B=0)}function N(){for(var r='计算中',n=0;n<=B;n++)r+='.';sr(r),3<=++B&&(B=0)}function O(){if(f!=ar.o){for(var r=0,n=0;n<v;n++){for(var a=4;a<v;a++){for(var t=1;t<=2&&!(r=o(t,q[n][a],q[n][a-1],q[n][a-2],q[n][a-3],q[n][a-4])?t:r)&&!(r=o(t,q[a][n],q[a-1][n],q[a-2][n],q[a-3][n],q[a-4][n])?t:r);t++);if(r)break}if(r)break}for(n=4;n<v;n++){for(a=4;a<v;a++){for(t=1;t<=2&&!(r=o(t,q[n][a],q[n-1][a-1],q[n-2][a-2],q[n-3][a-3],q[n-4][a-4])?t:r)&&!(r=o(t,q[n-4][a],q[n-3][a-1],q[n-2][a-2],q[n-1][a-3],q[n][a-4])?t:r);t++);if(r)break}if(r)break}if(r)return f=ar.i,c=r,1;for(var e=0,n=0;n<v;n++)for(a=0;a<v;a++)0!=q[a][n]&&e++;return e==v*v&&(f=ar.i,c=0,1)}function o(r,n,a,t,e,o){return n==r&&a==r&&t==r&&e==r&&o==r&&r}}function V(r,n){switch(f){case ar.o:f=er?ar.t:ar.u;var a=Math.floor(v/2);er||(G=[a,a]),V(a,a);break;case ar.t:ur(r,n,1),f=ar.u,O()?V():(fr&&(C(),clearInterval(j),fr=j=!1),e.postMessage([v,q,2,P]),j=Z(J,1e3)),W();break;case ar.u:ur(r,n,2),f=ar.t,j&&(clearInterval(j),j=!1,B=0),br(r,n),O()&&V(),W();break;case ar.i:sr(nr[c])}}var q,z,G,H,tr,er,fr,cr=!1;const ir=[{name:'坐标式:',P:function(r){for(var n,a,t='',e=0;e<r.length;e++)n=r[e][1],a=r[e][0],0!=e&&(t+=' '),t+=String.fromCharCode(n+65)+(a+1);return t}},{name:'数组式:',P:function(r){for(var n,a='[',t=0;t<r.length;t++)0!=t&&(a+=', '),n=r[t][1],a+=`[${r[t][0]}, ${n}]`;return a+']'}},{name:'分组式:',P:function(r){for(var n,a,t='',e='',o=0;o<r.length;o++)n=r[o][1],a=r[o][0],o%2==0?(0!=o&&(t+=', '),t+=`[${a}, ${n}]`):(1!=o&&(e+=', '),e+=`[${a}, ${n}]`);return`[[${t}], [${e}]]`}}];function ur(r,n,a){q[n][r]=a,tr.push([n,r])}function vr(){C(),fr=!1,j&&(clearInterval(j),j=!1),f=ar.o,er=E,q=U(v,function(){return U(v,X)}),z=G=H=!1,tr=[],V()}function sr(r){k.innerText=r}function br(r,n){sr(`[${n}, ${r}]`)}function kr(r,n){return[r=(r=Math.floor(r/i*v))<0?0:v<=r?v-1:r,n=(n=Math.floor(n/i*v))<0?0:v<=n?v-1:n]}function lr(r,n){z&&r==z[1]&&n==z[0]||(f!=ar.t||fr||br(r,n),z=[n,r],W())}function dr(r,n){f==ar.t?0==q[n][r]||godmode?(H=!1,V(r,n)):sr('该点已经有子'):f==ar.u&&sr('计算机正在思考')}'function'==typeof a&&a(l,o,w,k),vr(),o.addEventListener('mousemove',function(r){var[n,a]=kr(r.offsetX,r.offsetY);lr(n,a),r.preventDefault()}),o.addEventListener('click',function(r){var[n,r]=kr(r.offsetX,r.offsetY);dr(n,r)});var wr,$r,mr,Mr,Dr,Cr=0,xr=i*i/(v*v);function Fr(r){var n=o.getBoundingClientRect();return[Math.round(r.clientX-n.x),Math.round(r.clientY-n.y)]}function Wr(r){switch(r){case or.v:!function(){var r=0;switch(H=!1,f){case ar.t:r=2;break;case ar.u:C(),j&&(clearInterval(j),j=!1),f=ar.t,r=1;break;case ar.i:r=((er?1:0)+tr.length)%2+1,f=ar.t}if(0!=r)if(tr.length>=r){for(;r--;){var n=tr.pop();q[n[0]][n[1]]=0}0<tr.length?(n=tr[tr.length-1],G=[n[0],n[1]],br(n[1],n[0]),W()):(f=ar.o,G=!1,V())}else sr('已经是开局了')}();break;case or.reset:vr();break;case or.k:f!=ar.t||fr||(e.postMessage([v,q,1,P]),j=Z(N,1e3),fr=!0);break;case or.W:cr=!cr,W();break;case or.info:F(function(r,n){var a=yr('div');a.style.padding=T(b),$(a,or.info,'h2'),$(a,`第 ${tr.length} 手`),$(a,`先手: ${er?'玩家':'电脑'}`),$(a,`难度: ${gr[P]}(${P})`);var t,e=yr('fieldset'),o=yr('legend');for(t in e.style.marginBottom=T(b),o.innerHTML='<h3>棋局信息</h3>',Ar(e,o),ir){var f=ir[t];$(e,f.name,'h4');var c=yr('p');c.style.maxHeight=T(i/3),c.style.overflowY='auto',c.style.wordBreak='break-word',c.innerText=f.P(tr),Ar(e,c)}Ar(a,e),(o=yr('button')).innerText='确定',o.style.paddingLeft=o.style.paddingRight=T(b),o.addEventListener('click',n),Ar(a,o),Ar(r,a)})}}o.addEventListener('touchstart',function(r){var n;1==r.touches.length&&([wr,$r]=Fr(r.touches[0]),Cr=0,[n,r]=kr(wr,$r),lr(n,r),Dr=!0)}),o.addEventListener('touchmove',function(r){var n,a,t,e;1==r.touches.length&&Dr?([n,a]=Fr(r.touches[0]),0==Cr?3*xr<=(t=n-wr)*t+(e=a-$r)*e&&(Cr=1,mr=Math.round(3*Math.sqrt(20*xr)/5),Mr=Math.round(4*Math.sqrt(20*xr)/5)):(t=n-mr,e=a-Mr,n<0||a<0||i<=t||i<=e?(z=!1,W()):([t,e]=kr(t,e),lr(t,e))),r.preventDefault()):Dr=!1}),o.addEventListener('touchend',function(r){z&&dr(z[1],z[0]),r.preventDefault()}),l.addEventListener('keydown',function(r){if(z&&!p&&!r.ctrlKey&&!r.altKey&&!r.shiftKey&&!r.metaKey){var n,a;switch(r.key){case'ArrowLeft':case'a':n=[0,-1];break;case'ArrowRight':case'd':n=[0,1];break;case'ArrowUp':case'w':n=[-1,0];break;case'ArrowDown':case's':n=[1,0];break;case'Enter':case' ':dr(z[1],z[0])}n&&([a,r]=z,a+=n[0],r+=n[1],z=[a=a<0?0:v<=a?v-1:a,r=r<0?0:v<=r?v-1:r],W())}})}